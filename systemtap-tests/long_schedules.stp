%{
typedef unsigned long Uint;
typedef unsigned int Uint32;

typedef union {
    Uint val;
    Uint32 hval[2];
} HUint;

#define ERTS_HUINT_HVAL_LOW 0
#define ERTS_PTAB_ID_DATA_SHIFT 4
#define _PID_NUM_SIZE 15
#define _GETBITS(X,Pos,Size) (((X) >> (Pos)) & ~(~((Uint) 0) << (Size)))
%}

function __pid_number:long(id) %{
    HUint huint;
    Uint data;
    huint.val = (Uint)STAP_ARG_id;
    data = (Uint) (huint.hval[ERTS_HUINT_HVAL_LOW] >> ERTS_PTAB_ID_DATA_SHIFT);
    STAP_RETVALUE = _GETBITS(data,0,_PID_NUM_SIZE);
%}

probe process("beam.smp").function("monitor_long_schedule_proc")
{
    reductions = p->reds;
    pid_number = __pid_number(process->common->id);

    printf("Long schedule in %d having done %d reductions\n", pid_number, reductions);
}